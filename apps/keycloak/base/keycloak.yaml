# https://www.keycloak.org/operator/advanced-configuration

apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
  name: keycloak
spec:
  additionalOptions:
    - name: metrics-enabled
      value: "true"
  bootstrapAdmin:
    user:
      secret: keycloak-user
  db:
    database: keycloak
    host: keycloak-pg-cluster-rw
    passwordSecret:
      key: password
      name: keycloak-pg-cluster-app
    usernameSecret:
      key: username
      name: keycloak-pg-cluster-app
    vendor: postgres
  env:
  - name: KC_METRICS_ENABLED
    value: "true"
  - name: KC_CACHE_METRICS_HISTOGRAMS_ENABLED
    value: "true"
  - name: KC_HTTP_METRICS_HISTOGRAMS_ENABLED
    value: "true"
  - name: KC_EVENT_METRICS_USER_ENABLED
    value: "true"
  features:
    enabled:
    - docker
    - client-auth-federated
    - fips
    - ipa-tuura-federation
    - kerberos
    - kubernetes-service-accounts
    - passkeys
    - spiffe
  hostname:
    # admin: https://keycloak.apps.iaas.wcooke.me/admin
    hostname: https://keycloak.apps.iaas.wcooke.me
    # strict: false
  http:
    tlsSecret: keycloak-certificate
  image: registry.wcooke.me:5000/keycloak/keycloak-fips:26.5.4-fips
  ingress:
    annotations:
      cert-manager.io/cluster-issuer: iaas-wcooke-me
      forecastle.stakater.com/appName: Keycloak
      forecastle.stakater.com/expose: "true"
      forecastle.stakater.com/group: Kubernetes
      forecastle.stakater.com/icon: https://keycloak.apps.iaas.wcooke.me/resources/w2ekr/admin/keycloak.v2/logo.svg
      forecastle.stakater.com/network-restricted: "true"
      ingress.cilium.io/tls-passthrough: enabled
    className: cilium
    enabled: false
    tlsSecret: keycloak-ingress-cert
    # Comment instances if using the HPA
  # instances: 2
  networkPolicy:
    management:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-prometheus-stack
  proxy:
    headers: xforwarded # double check your reverse proxy sets and overwrites the X-Forwarded-* headers
  # resources:
  #   limits:
  #     cpu: 12
  #     memory: 36Gi
  #   requests:
  #     cpu: 4
  #     memory: 12Gi
  scheduling:
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            topologyKey: kubernetes.io/hostname
  serviceMonitor:
    enabled: true
    interval: 10s
  # startOptimized: true
