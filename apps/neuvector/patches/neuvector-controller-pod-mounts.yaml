# These four patches add private CA certificates to the neuvector-controller pod
# 1. Using init container to append private CA certificates
- op: add
  path: /spec/template/spec/initContainers/-
  value:
    args:
    - |
      ls -al /private-ca-certificates
      ls -al /etc/ssl/certs/
      for cert in /etc/ssl/certs/*.pem /private-ca-certificates/*; do
        echo "Adding cert: $cert"
        cat "${cert}" >> /new-ca-certificates/ca-certificates.crt
        echo "" >> /new-ca-certificates/ca-certificates.crt
      done
      ls -al /new-ca-certificates
    command: ["/usr/bin/bash", "-c"]
    image: docker.io/neuvector/controller:5.4.8
    name: certificate-fixer
    securityContext:
      runAsUser: 0
    volumeMounts:
    - mountPath: /new-ca-certificates
      name: new-ca-certificates
      readOnly: false
    - mountPath: /private-ca-certificates
      name: private-ca-certificates
      readOnly: true

# 2. The volume to hold the new CA certificates
- op: add
  path: /spec/template/spec/volumes/-
  value:
    emptyDir:
      medium: Memory
      sizeLimit: 5Mi
    name: new-ca-certificates

# 3. The volume for the private CA certificates
- op: add
  path: /spec/template/spec/volumes/-
  value:
    configMap:
      defaultMode: 420
      # Change this to your config map name that holds the private CA certificates
      name: tm-ca-bundle
    name: private-ca-certificates

# 4. Mount the volume to hold the combined CA certificates
- op: add
  path: /spec/template/spec/containers/0/volumeMounts/-
  value:
    mountPath: /etc/ssl/certs/ca-certificates.crt
    name: new-ca-certificates
    readOnly: true
    subPath: ca-certificates.crt

# Using trust-manager
# - op: add
#   path: /spec/template/spec/containers/0/volumeMounts/-
#   value:
#     mountPath: /etc/ssl/certs/ca-certificates.crt
#     name: ca
#     readOnly: true
#     subPath: ca-bundle.pem
# - op: add
#   path: /spec/template/spec/volumes/-
#   value:
#     configMap:
#       defaultMode: 420
#       name: tm-ca-bundle
#     name: ca
