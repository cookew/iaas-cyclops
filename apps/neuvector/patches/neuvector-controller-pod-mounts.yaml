# These four patches add private CA certificates to the neuvector-controller pod
# 1. Using init container to append private CA certificates
- op: add
  path: /spec/template/spec/initContainers/-
  value:
    args:
    - |
      echo Certificates in /private-ca-certificates:
      ls -al /private-ca-certificates
      echo Existing CA certificates in /etc/ssl/certs:
      ls -al /etc/ssl/certs/
      echo Combining CA certificates
      for cert in /etc/ssl/certs/*.{0,pem} /private-ca-certificates/*
      do
        echo "Adding cert: $cert"
        cat "${cert}" >> /new-ca-certificates/ca-certificates.crt
        echo "" >> /new-ca-certificates/ca-certificates.crt
      done
      echo New CA certificates file:
      ls -al /new-ca-certificates
    command: ["/usr/bin/bash", "-c"]
    image: docker.io/neuvector/controller:5.4.8
    name: ca-certificate-fixer
    # securityContext:
    #   runAsUser: 0
    volumeMounts:
    - mountPath: /new-ca-certificates
      name: new-ca-certificates
      readOnly: false
    - mountPath: /private-ca-certificates
      name: private-ca-certificates
      readOnly: true

# 2. The volume to hold the new CA certificates
- op: add
  path: /spec/template/spec/volumes/-
  value:
    emptyDir:
      medium: Memory
      sizeLimit: 5Mi
    name: new-ca-certificates

# 3. The volume for the private CA certificates
- op: add
  path: /spec/template/spec/volumes/-
  value:
    configMap:
      defaultMode: 420
      # Change this to your config map name that holds the private CA certificates
      name: tm-ca-bundle
    name: private-ca-certificates

# 4. Mount the volume to hold the combined CA certificates
- op: add
  path: /spec/template/spec/containers/0/volumeMounts/-
  value:
    mountPath: /etc/ssl/certs/ca-certificates.crt
    name: new-ca-certificates
    readOnly: true
    subPath: ca-certificates.crt
---
# Using trust-manager, or any config map
# This adds a volumeMount to the container
- op: add
  path: /spec/template/spec/containers/0/volumeMounts/-
  value:
    mountPath: /etc/ssl/certs/ca-certificates.crt
    name: ca
    readOnly: true
    # Change this to the key name in the config map that holds the CA certificate
    subPath: ca-bundle.pem
# This adds the volume to the pod, which is used by the container
- op: add
  path: /spec/template/spec/volumes/-
  value:
    configMap:
      defaultMode: 420
      # Change this to your config map name that holds the private CA certificates
      name: tm-ca-bundle
    name: ca
